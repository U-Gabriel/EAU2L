let c=1;document.addEventListener("DOMContentLoaded",function(){const m=document.getElementById("meeting_date"),f=document.getElementById("meeting_hour"),h=document.getElementById("calendarGrid"),y=document.getElementById("timeGrid"),p=document.getElementById("nextBtn"),w=document.getElementById("prevBtn");let d=document.getElementById("error-banner");const g=document.querySelector(".audit-card-premium");if(!h||!p||!m)return;const q=document.getElementById("auditForm");q&&q.reset(),m.value="",f.value="";let v=new Date,B=[];if(fetch("/api/off-days").then(t=>t.json()).then(t=>{B=t,L(v)}),!d){d=document.createElement("div"),d.id="error-banner",d.className="mb-4 animate-in",d.innerHTML=`
            <div class="flex items-center gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
                <span class="font-medium text-xs">Veuillez remplir tous les champs obligatoires (*).</span>
            </div>`;const t=document.querySelector(".flex.justify-between.items-center.mt-8");t?t.parentNode.insertBefore(d,t):g&&g.appendChild(d)}h.addEventListener("click",function(t){const e=t.target.closest(".cal-day");if(e&&!e.classList.contains("empty")&&!e.classList.contains("disabled")){const n=e.textContent,r=document.querySelector(".month-year").textContent.split(" "),s=["Janvier","Février","Mars","Avril","Mai","Juin","Juillet","Août","Septembre","Octobre","Novembre","Décembre"].indexOf(r[0])+1,u=`${r[1]}-${String(s).padStart(2,"0")}-${String(n).padStart(2,"0")}`;document.querySelectorAll(".cal-day").forEach(i=>i.classList.remove("active","bg-blue-600","border-blue-500")),e.classList.add("active","bg-blue-600","border-blue-500"),m.value=u,f.value="",d.classList.add("hidden"),D(u)}});function L(t){h.innerHTML="";const e=t.getFullYear(),n=t.getMonth(),r=["Janvier","Février","Mars","Avril","Mai","Juin","Juillet","Août","Septembre","Octobre","Novembre","Décembre"];document.querySelector(".month-year").textContent=`${r[n]} ${e}`;let o=new Date(e,n,1).getDay(),s=o===0?6:o-1;const u=new Date(e,n+1,0).getDate(),i=new Date;i.setHours(0,0,0,0);for(let a=0;a<s;a++)h.insertAdjacentHTML("beforeend",'<div class="cal-day empty opacity-0"></div>');for(let a=1;a<=u;a++){const l=document.createElement("div");l.className="cal-day transition-all duration-300 hover:scale-105 cursor-pointer p-2 sm:p-4 rounded-lg text-center text-white font-medium border border-white/5 bg-white/5",l.textContent=a;const E=new Date(e,n,a),S=`${e}-${String(n+1).padStart(2,"0")}-${String(a).padStart(2,"0")}`;E<i||E.getDay()===0||E.getDay()===6||B.includes(S)?(l.classList.add("disabled","opacity-20"),l.style.pointerEvents="none"):fetch(`/api/has-slots?date=${S}`).then(x=>x.json()).then(x=>{x.available||(l.classList.add("disabled","opacity-20"),l.style.pointerEvents="none")}).catch(()=>{}),m.value===S&&l.classList.add("active","bg-blue-600","border-blue-500"),h.appendChild(l)}}function D(t){y.innerHTML="<div class='col-span-2 text-white/30 text-sm animate-pulse'>Chargement...</div>",fetch(`/api/available-slots?date=${t}`).then(e=>e.json()).then(e=>{if(y.innerHTML="",!e||e.length===0){y.innerHTML="<div class='col-span-2 text-red-400 text-xs p-3'>Aucun créneau.</div>";return}e.forEach(n=>{const r=document.createElement("div");r.className="time-slot p-3 rounded-lg border border-white/5 bg-white/5 text-white text-center cursor-pointer hover:bg-white/10 transition-all text-sm",r.textContent=n,f.value===n&&r.classList.add("selected","border-blue-500","bg-blue-600/20"),r.onclick=()=>{document.querySelectorAll(".time-slot").forEach(o=>o.classList.remove("selected","border-blue-500","bg-blue-600/20")),r.classList.add("selected","border-blue-500","bg-blue-600/20"),f.value=n,d.classList.add("hidden")},y.appendChild(r)})})}function C(){const t=document.querySelector(`.form-step[data-step="${c}"]`),e=document.getElementById("error-banner");let n=!0;t.querySelectorAll('input[required]:not([type="radio"]), select[required], textarea[required]').forEach(s=>{!s.value||!s.value.trim()?(s.classList.add("!border-red-500/50"),n=!1):s.classList.remove("!border-red-500/50")}),c===1&&!n&&(document.querySelector(".calendar-wrapper").classList.add("animate-shake","border-red-500/50"),setTimeout(()=>{document.querySelector(".calendar-wrapper").classList.remove("animate-shake")},500));const o=t.querySelector('input[type="radio"][required]');if(o){const s=o.name,u=t.querySelector(`input[name="${s}"]:checked`),i=t.querySelectorAll(".objective-content");u?i.forEach(a=>a.classList.remove("invalid-card")):(i.forEach(a=>a.classList.add("invalid-card")),n=!1)}return c===1&&(!m.value||!f.value)&&(n=!1),n?e.classList.add("hidden"):(e.classList.remove("hidden"),e.scrollIntoView({behavior:"smooth",block:"center"}),e.classList.add("animate-shake"),setTimeout(()=>e.classList.remove("animate-shake"),500)),n}if(typeof b>"u")var b={};p.addEventListener("click",function(t){t.preventDefault();const e=document.getElementById("error-banner");e.classList.add("hidden");const n=document.querySelector(`.form-step[data-step="${c}"]`);if(!n)return;const r=document.getElementById("error-banner");if(r&&r.classList.add("hidden"),C())if(n.querySelectorAll("input, select, textarea").forEach(s=>{s.type==="radio"?s.checked&&(b[s.name]=s.value):s.name&&(b[s.name]=s.value)}),c===4){const s=document.getElementById("alert-objectifs");s&&s.classList.add("hidden"),k()}else I(1);else if(e.classList.remove("hidden"),e.scrollIntoView({behavior:"smooth",block:"center"}),c===4){const o=document.getElementById("alert-objectifs");o&&o.classList.remove("hidden")}}),w.addEventListener("click",t=>{t.preventDefault(),c>1&&I(-1)});function I(t){const e=document.querySelectorAll(".form-step"),n=e.length,r=document.getElementById("error-banner");r&&r.classList.add("hidden"),e[c-1].classList.remove("active"),c+=t,e[c-1].classList.add("active");const o=document.getElementById("progress-line");if(o){const i=(c-1)/(n-1)*100;o.style.width=`${i}%`}document.querySelectorAll(".step-item").forEach(i=>{const a=parseInt(i.dataset.step);i.classList.toggle("active",a===c);const l=i.querySelector(".step-circle");l&&(l.classList.toggle("!border-blue-500",a<=c),l.classList.toggle("!text-white",a<=c),l.classList.toggle("bg-blue-600",a<=c))}),w.classList.toggle("hidden",c===1);const s=c===n;p.querySelector("span").textContent=s?"Confirmer le RDV":"Suivant";const u=g.offsetTop-50;window.scrollTo({top:u,behavior:"smooth"})}document.querySelectorAll(".btn-cal-nav").forEach((t,e)=>{t.onclick=n=>{n.preventDefault(),v.setMonth(v.getMonth()+(e===0?-1:1)),L(v)}}),L(v);function k(){console.log("Envoi des données...",b);const t=document.querySelector('meta[name="csrf-token"]')?.getAttribute("content")||document.querySelector('input[name="_token"]')?.value;fetch("/api/submit",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":t,Accept:"application/json"},body:JSON.stringify(b)}).then(e=>e.json()).then(e=>{e.success?T():alert("Erreur: "+e.message)}).catch(e=>{console.error("Erreur:",e),alert("Une erreur est survenue lors de l'envoi."),p&&(p.disabled=!1)})}function T(){const t=document.getElementById("success-modal"),e=document.getElementById("modal-card"),n=document.getElementById("countdown-text");if(!t||!e){console.warn("Éléments de la modale manquants, redirection directe."),window.location.href="/";return}t.classList.remove("hidden"),setTimeout(()=>{e.classList.remove("scale-95","opacity-0"),e.classList.add("scale-100","opacity-100")},50);let r=15;const o=setInterval(()=>{r--,n&&(n.textContent=r),r<=0&&(clearInterval(o),window.location.href="/")},1e3)}});
